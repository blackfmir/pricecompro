# --- Валюти: список
@router.get("/ui/currencies", response_class=HTMLResponse)
def ui_currencies_list(request: Request, db: DBSession):
    items = currency_crud.list_(db)
    return templates.TemplateResponse(
        "currencies_list.html",
        {"request": request, "items": items, "error": request.query_params.get("error")}
    )

# --- Валюти: форма створення
@router.get("/ui/currencies/new", response_class=HTMLResponse)
def ui_currencies_new(request: Request):
    return templates.TemplateResponse(
        "currencies_form.html",
        {"request": request, "mode": "create", "item": None, "error": None}
    )

# --- Валюти: створити
@router.post("/ui/currencies")
def ui_currencies_create(
    request: Request,
    db: DBSession,
    name: FormStr,
    iso_code: FormStr,
    symbol_left: FormOptStr = None,
    symbol_right: FormOptStr = None,
    decimals: Annotated[int, Form(2)] = 2,  # noqa: B008 handled via Annotated
    rate: Annotated[float, Form(1.0)] = 1.0,  # noqa: B008 handled via Annotated
    active: FormBool = False,
):
    # простенька перевірка унікальності ISO
    if currency_crud.get_by_iso(db, iso_code):
        return templates.TemplateResponse(
            "currencies_form.html",
            {
                "request": request,
                "mode": "create",
                "item": None,
                "error": f"Валюта з ISO '{iso_code}' вже існує",
            },
            status_code=400,
        )
    payload = CurrencyCreate(
        name=name,
        iso_code=iso_code,
        symbol_left=symbol_left,
        symbol_right=symbol_right,
        decimals=decimals,
        rate=rate,
        active=active,
    )
    currency_crud.create(db, payload)
    return RedirectResponse(url="/ui/currencies", status_code=303)

# --- Валюти: форма редагування
@router.get("/ui/currencies/{currency_id}/edit", response_class=HTMLResponse)
def ui_currencies_edit(request: Request, db: DBSession, currency_id: int):
    item = currency_crud.get(db, currency_id)
    if not item:
        return RedirectResponse(url="/ui/currencies?error=Валюта+не+знайдена", status_code=303)
    return templates.TemplateResponse(
        "currencies_form.html",
        {"request": request, "mode": "edit", "item": item, "error": None},
    )

# --- Валюти: зберегти редагування
@router.post("/ui/currencies/{currency_id}/edit")
def ui_currencies_update(
    request: Request,
    db: DBSession,
    currency_id: int,
    name: FormStr,
    iso_code: FormStr,
    symbol_left: FormOptStr = None,
    symbol_right: FormOptStr = None,
    decimals: Annotated[int, Form(2)] = 2,
    rate: Annotated[float, Form(1.0)] = 1.0,
    active: FormBool = False,
):
    # контроль унікальності ISO при зміні
    other = currency_crud.get_by_iso(db, iso_code)
    if other and other.id != currency_id:
        item = currency_crud.get(db, currency_id)
        return templates.TemplateResponse(
            "currencies_form.html",
            {
                "request": request,
                "mode": "edit",
                "item": item,
                "error": f"Інша валюта з ISO '{iso_code}' вже існує",
            },
            status_code=400,
        )

    payload = CurrencyUpdate(
        name=name,
        iso_code=iso_code,
        symbol_left=symbol_left,
        symbol_right=symbol_right,
        decimals=decimals,
        rate=rate,
        active=active,
    )
    obj = currency_crud.update(db, currency_id, payload)
    if not obj:
        return RedirectResponse(url="/ui/currencies?error=Валюта+не+знайдена", status_code=303)
    return RedirectResponse(url="/ui/currencies", status_code=303)

# --- Валюти: зробити основною
@router.post("/ui/currencies/{currency_id}/set-primary")
def ui_currencies_set_primary(db: DBSession, currency_id: int):
    ok = currency_crud.set_primary(db, currency_id)
    url = "/ui/currencies" if ok else "/ui/currencies?error=Валюта+не+знайдена"
    return RedirectResponse(url=url, status_code=303)

# --- Валюти: видалити (з перевірками)
@router.post("/ui/currencies/{currency_id}/delete")
def ui_currencies_delete(db: DBSession, currency_id: int):
    ok, err = currency_crud.delete_safe(db, currency_id)
    url = "/ui/currencies" if ok else f"/ui/currencies?error={err.replace(' ', '+')}"
    return RedirectResponse(url=url, status_code=303)